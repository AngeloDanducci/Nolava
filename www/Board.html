<!DOCTYPE html>
<html>
<head lang="en">
   <meta charset="utf-8">
   <title>Nolava</title>
   <link rel="stylesheet" href="reset.css" />
   <link rel="stylesheet" href="nolava.css" />
   <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.4/themes/ui-darkness/jquery-ui.css">
   <script src="https://code.jquery.com/jquery-2.2.1.min.js" integrity="sha256-gvQgAFzTH6trSrAWoH1iPo9Xc96QxSZ3feW6kem+O00=" crossorigin="anonymous"></script>
   <script src="https://code.jquery.com/ui/1.12.0-beta.1/jquery-ui.min.js" integrity="sha256-WyjlLy3rvVSitHOXMctYkMCOU6GAletPg+qniNKLCQM=" crossorigin="anonymous"></script>
   <script>
$(document).ready(function() {
  $("#name-modal").dialog({autoOpen:false, modal:true,show:"blind",hide:"blind"})
  
  if (!getCookieValue('name')) {
    $('#name-modal').dialog('open');
  }
});

var wsocket = new WebSocket('ws://nolava.tk:1400', 'protocolOne');
//var wsocket = "";

document.onkeydown = function(event) {
  if (window.event)
    keycode = window.event.keyCode;
  else if (event)
    keycode = event.which;

  if (keycode == 13)
    send_msg();
}

wsocket.onopen = function(event) {
  if (getCookieValue('name'))
    wsocket.send('name:' + getCookieValue('name'));
  if (getCookieValue('session'))
    wsocket.send('session:' + getCookieValue('session'));
}

wsocket.onmessage = function(event) {
  var msg = event.data;
  var time = new Date(msg.date);

  console.log(msg);

  var i = msg.indexOf(':')
  // split only on first :
  var action = [msg.slice(0,i), msg.slice(i+1)];

  if (action[0] == 'chat') {
    add_chat(action[1]);
  }
  else if (action[0] == 'disconnected') {
    add_server_message(action[1] + ' disconnected.', 'red');
  }
  else if (isFinite(action[0])) {
    add_server_message(action[1] + ' connected.', 'white');
  }
  else if (action[0] == 'quest') {
    if (action[1] == 'member') {
      // They are on the current team for quest
    }
    else if (action[1] == 'leader') {
      // They are leader of current quest
    }
  }
  else if (action[0] == 'assign') {
    // user just got assigned place OR role
    // if is number (then 'place' given)
    if (isFinite(action[1])) {
      console.log("You were given place: "+action[1]);
    }
    else { // Role given
      console.log("You were given role: "+action[1]);
    }
    
    // TODO: replace button with users card
    // TODO: place session token in cookie
  }
  else if (action[0] == 'session') {
    document.cookie = 'session=' + action[1];
  }
}

// Return value from cookies' "{key}={value};"
function getCookieValue(key) {
  var s = '; ' + document.cookie;
  var parts = s.split('; ' + key + '=');
  if (parts.length == 2) return parts.pop().split(';').shift();
}

function add_server_message(message, color) {
  var newDiv = document.createElement('div');
  var msgSpan = document.createElement('span');

  msgSpan.innerHTML = message;
  msgSpan.className = color;
  newDiv.appendChild(msgSpan);
  document.getElementById('chat').appendChild(newDiv);
}

function add_chat(message) {
  var newDiv = document.createElement('div');
  var userSpan = document.createElement('span');
  var msgSpan = document.createElement('span');

  // Get user
  var i = message.indexOf(':')
  var user = message.slice(0,i);
  var message = message.slice(i+1);

  userSpan.innerHTML = user + ': ';
  msgSpan.innerHTML = message;
  // TODO: color code users?
  newDiv.appendChild(userSpan);
  newDiv.appendChild(msgSpan);

  document.getElementById('chat').appendChild(newDiv);
}

function send_name() {
  $('#name-modal').dialog('close');
  var name = document.getElementById('name-box').value;
  if (name.length > 0) {
    wsocket.send('name:' + name);
  }
  document.cookie = 'name=' + name + ';';
}

function send_msg() {
  var msg = document.getElementById('chat-input').value;
    if (msg.length > 0) {
    console.log('Sending: ' + msg);
    try {
      wsocket.send('chat:'+msg);
      document.getElementById('chat-input').value = '';
    }
    catch (err) {}
  }
}

function join_game(place) {
  wsocket.send('join:' + place);
}

</script>
</head>
<body>
<div id="name-modal" class="ui-dialog" title="What is your name?">
  <input id="name-box" type="text"><button onclick="send_name()">Submit</button>
</div>

<div id="game">
  <div id="board">
    <img src="images/board5.png" alt="Game Board"/>
  </div>
  <div id="players">
    <div class="player">
      <button id="p1" type="button" onclick="join_game(1)">Join Game</button>
    </div>
    <div class="player">
      <button id="p2"  type="button" onclick="join_game(2)">Join Game</button>
    </div>
    <div class="player">
      <button id="p3" type="button" onclick="join_game(3)">Join Game</button>
    </div>
    <div class="player">
      <button id="p4" type="button" onclick="join_game(4)">Join Game</button>
    </div>
    <div class="player">
      <button id="p5" type="button" onclick="join_game(5)">Join Game</button>
    </div>
    <div class="player">
      <button id="p6" type="button" onclick="join_game(6)">Join Game</button>
    </div>
    <div class="player">
      <button id="p7" type="button" onclick="join_game(7)">Join Game</button>
    </div>
    <div class="player">
      <button id="p8" type="button" onclick="join_game(8)">Join Game</button>
    </div>
    <div class="player">
      <button id="p9" type="button" onclick="join_game(9)">Join Game</button>
    </div>
    <div class="player">
      <button id="p10" type="button" onclick="join_game(10)">Join Game</button>
    </div>
  </div>
  <div id="chat-wrapper">
    <div id="chat">
      <div>Welcome to Nolava!</div>
      <!--<div><span class="green">User: </span>Placeholder</div>-->
    </div>
    <input id='chat-input' type='text'>
  </div>
</div>
<p id="text">
  Blue Tint = Team Ruthra         Red Tint = Team Derdrom
</p>

</body>
</html>
